<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hiển thị dữ liệu API theo trạng thái</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/searchpanes/1.4.0/css/searchPanes.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/searchpanes/1.4.0/js/dataTables.searchPanes.min.js"></script>
  <link rel="stylesheet" href="style.css">
  <style>
    table.table-striped {
      width: 100%;
    }

    table.table-striped th, table.table-striped td {
      padding: 8px;
      white-space: normal;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn {
      background-color: #FF593E;
      color: aliceblue;
    }

    .dataTables_info {
      display: none;
    }

    h3 {
      text-align: center;
    }

    .bordered-table {
      border: 1px solid #ccc;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }

    .name-column {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: help;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="bordered-table">
      <h3>order table - Xác nhận</h3>
      <table id="confirmedTable" class="table table-striped">
        <thead>
          <tr>
            <th>STT</th>
            <th class="name-column">Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Notes</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
      </table>
    </div>

    <div class="bordered-table">
      <h3>order table - Đang giao</h3>
      <table id="shippingTable" class="table table-striped">
        <thead>
          <tr>
            <th>STT</th>
            <th class="name-column">Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Notes</th>
            <th>Total</th>
            <th>Status</th>
          </tr>
        </thead>
      </table>
    </div>

    <div class="bordered-table">
      <h3>order table - Đang chuẩn bị</h3>
      <table id="preparingTable" class="table table-striped">
        <thead>
          <tr>
            <th>STT</th>
            <th class="name-column">Name</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Notes</th>
            <th>Total</th>
            <th>Status</th>
            <th>Action</th> <!-- Add a new column for the button -->
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    $(document).ready(function () {
      var statusMapping = {
        'xác nhận': 'confirmedTable',
        'đang giao': 'shippingTable',
        'đang chuẩn bị': 'preparingTable',
      };
      var tableIndices = {
        'confirmedTable': 1,
        'shippingTable': 1,
        'preparingTable': 1
      };

      function initializeDataTable(tableId) {
        if (!$.fn.dataTable.isDataTable('#' + tableId)) {
          $('#' + tableId).DataTable({
            paging: false,
          });
        }
      }

      $.ajax({
        url: 'http://localhost:3000/api/getAllorder',
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          data.forEach(function (order, index) {
            var productNames = order.products.map(function (product) {
              return product.product_name;
            }).join(', ');

            var nameLink = productNames;
            var phone = order.phone;
            var address = order.address;
            var notes = order.notes;
            var total = order.total;
            var statusName = order.status.status_name;

            var targetTable = statusMapping[statusName.toLowerCase()];

            if (targetTable) {
              initializeDataTable(targetTable);

              var addButton = '<button class="change-status-button" data-order-id="' + order.id + '">Chuyển sang Đang giao</button>';

              var table = $('#' + targetTable).DataTable();
              var row = [
                tableIndices[targetTable]++,
                nameLink,
                phone,
                address,
                notes,
                total,
                statusName,
                addButton
              ];

              // Add a row to the "Đang chuẩn bị" table
              if (targetTable === 'preparingTable') {
                table.row.add(row).draw();
              }
            }
          });
        },
        error: function (error) {
          console.log('Error:', error);
        }
      });

      // Add a click event handler for the "Chuyển sang Đang giao" buttons
      $(document).on('click', '.change-status-button', function () {
        var orderId = $(this).data('order-id');
        var newStatus = 'đang giao'; // Update the new status

        // Send an AJAX request to update the order's status
        $.ajax({
          url: 'http://localhost:3000/api/updateOrderStatus',
          method: 'POST',
          data: { orderId: orderId, newStatus: newStatus },
          dataType: 'json',
          success: function (data) {
            // Handle the response here
            // You may want to remove the row from the "Đang chuẩn bị" table and add it to the "Đang giao" table.
            var tableId = 'shippingTable'; // Change to your target table
            var table = $('#' + tableId).DataTable();
            table.row.add(table.row($(this).closest('tr')).data()).draw();
            table.row($(this).closest('tr')).remove().draw();
          },
          error: function (error) {
            console.log('Error:', error);
          }
        });
      });
    });
  </script>
</body>
</html>
