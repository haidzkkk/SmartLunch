<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chi tiết đơn hàng</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    .container {
      margin-top: 20px;
    }
    
    h3 {
      text-align: center;
      color: #FF593E;
    }
    
    #order-details {
      background-color: #f5f5f5;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 5px;
    }
    
    #order-details p {
      margin: 0;
    }
    
    #order-details strong {
      font-weight: bold;
    }

    .status-text {
      font-weight: bold;
      color: #007bff;
    }

    .radio-group {
      margin-top: 10px;
    }

  </style>
</head>
<body>
  <div class="container">
    <h3>Chi tiết đơn hàng</h3>
    <div id="order-details">
      <p><strong>Tên: </strong><span id="name">Đang tải...</span></p>
      <p><strong>Số điện thoại: </strong><span id="phone">Đang tải...</span></p>
      <p><strong>Địa chỉ: </strong><span id="address">Đang tải...</span></p>
      <p><strong>Ghi chú: </strong><span id="notes">Đang tải...</span></p>
      <p><strong>Tên sản phẩm: </strong><span id="productName">Đang tải...</span></p>
      <p><strong>Giá sản phẩm: </strong><span id="productPrice">Đang tải...</span></p>
      <p><strong>Số lượng sản phẩm: </strong><span id="productQuanlity">Đang tải...</span></p>
      <p><strong>Kích cỡ : </strong><span id="productSize">Đang tải...</span></p>
      <p><strong>Tổng cộng: </strong><span id="total">Đang tải...</span></p>
      <p><strong>Trạng thái: <span id="status" class="status-text">Đang tải...</span></strong></p>
      
      <!-- Thêm radio group cho isPayment -->
      <div class="radio-group" id="paymentRadioGroup">
        <label for="isPayment">Trạng thái thanh toán:</label>
        <input type="radio" id="paidRadio" name="isPayment" value="true"> <label for="paidRadio">Hoàn tiền </label>
        <input type="radio" id="unpaidRadio" name="isPayment" value="false"> <label for="unpaidRadio">Chưa hoàn</label>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    var idorder = window.location.href.split('/').pop();

    function updateStatus() {
      $.ajax({
        url: 'http://localhost:3000/api/order/' + idorder,
        method: 'GET',
        dataType: 'json',
        success: function (data) {
          $('#name').text(data.address.recipientName || 'Không có tên');
          $('#phone').text(data.address.phoneNumber || 'Không có số điện thoại');
          $('#address').text(data.address.addressLine || 'Không có địa chỉ');

           if (data.products && data.products.length > 0) {
          // Lấy thông tin của sản phẩm đầu tiên trong mảng
          var product = data.products[0];
          $('#productName').text(product.product_name || 'Không có tên sản phẩm');
          $('#productPrice').text(product.product_price || 'Không có giá sản phẩm');
          $('#productQuanlity').text(product.purchase_quantity || 'Không có số lượng sản phẩm');
          $('#productSize').text(product.sizeName || 'Không có số lượng sản phẩm');
        } else {
          $('#productName').text('Không có tên sản phẩm');
          $('#productPrice').text('Không có giá sản phẩm');
          $('#productQuanlity').text('Không có số lượng sản phẩm');
          $('#productSize').text('Không có số lượng sản phẩm');
        }
          $('#notes').text(data.notes || 'Không có ghi chú');
          $('#total').text(data.total || 'Không có tổng cộng');

          var statusText = data.status ? data.status.status_name : 'Không có trạng thái';
          $('#status').text(statusText);

          // Ẩn/mostrar radio button tùy thuộc vào trạng thái của đơn hàng
          if (statusText === 'Đã Hủy') {
            $('#paymentRadioGroup').hide();
          } else {
            $('#paymentRadioGroup').show();
            // Cập nhật trạng thái radio isPayment
            if (data.isPayment) {
              $('input[name="isPayment"][value="true"]').prop('checked', true);
            } else {
              $('input[name="isPayment"][value="false"]').prop('checked', true);
            }
          }
        },
        error: function (error) {
          console.log('Lỗi:', error);
          $('#status').text('Lỗi khi tải trạng thái');
        }
      });
    }

    // Thêm sự kiện change cho radio buttons
    $('input[name="isPayment"]').on('change', function () {
      var isPaymentValue = $(this).val();
      // Gửi yêu cầu AJAX để cập nhật trạng thái isPayment
      $.ajax({
        url: 'http://localhost:3000/api/updateIsPayment/' + idorder,
        method: 'PATCH',
        data: { isPayment: isPaymentValue },
        success: function (data) {
          console.log('Trạng thái isPayment đã được cập nhật:', data);
          confirmOrder(idorder, isPaymentValue);
        },
        error: function (error) {
          console.log('Lỗi khi cập nhật trạng thái isPayment:', error);
        }
      });
    });

    function confirmOrder(idorder, isPaymentValue) {
      var newStatus = isPaymentValue === 'true' ? '6560466ed13bcf53cec8deea' : '653bc0a72006e5791beab35b';
      // Gọi API PATCH khi nhấp vào radio button
      $.ajax({
        url: 'http://localhost:3000/api/order/' + idorder,
        method: 'PATCH',
        data: { status: newStatus },
        dataType: 'json',
        success: function (response) {
          console.log('Phản hồi từ API:', response);
          // Cập nhật bảng và tab (đoạn mã updateTable không được hiển thị)
        },
        error: function (error) {
          console.log('Lỗi:', error);
        }
      });
    }

    $(document).ready(function () {
      updateStatus();
    });
  </script>
</body>
</html>
